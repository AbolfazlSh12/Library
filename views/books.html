<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/stylesheets/style.css" />
    <link rel="icon" href="../../images/icon.png" type="image/x-icon" />
    <title>Library</title>
    <style>
      body {
        background-color: rgb(225, 255, 244);
      }
    </style>
  </head>

  <body>
    <a id="addBook" onclick="auth()"><button type="button">Add Book</button></a>
    <ul>
      <% for(let i=0; i < books.length; i++) { %>
      <li>
        <h1><%= books[i].name %></h1>
        <button data-id="<%= books[i]._id %>" onclick="rent(this)">rent</button>
      </li>
      <% } %>
    </ul>
    <script src="./javascripts/swal.js"></script>
    <script src="../javascripts/cookie.js"></script>
    <script>
      const rent = async (button) => {
        const bookId = button.dataset.id;
        const rawResponse = await fetch("/rent", {
          method: "POST",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ bookId }),
        });
        if (rawResponse.status === 401) {
          swal("You'r not logged in !", "You have to login firs.", "error");
          return;
        }
        if (rawResponse.status !== 200) {
          swal(
            "Duplicate Book !",
            "This book is already in your cart.",
            "error"
          );
          return;
        }
        swal("Success Add Book!", "Book added in your cart", "success");
      };
    </script>
    <script>
      function auth() {
        fetch("/books/addBook").then(function (response) {
          if (response.status == 401) {
            // console.log(getCookie("token"));
            swal(
              "You'r not logged in !",
              "You have to login firs.",
              "error"
            ).then(function () {
              window.location = "/auth/login";
            });
          } else if (response.status == 403) {
            swal("You'r not Admin !", "Only Admin can Add Book!", "error").then(
              function () {
                window.location = "/books";
              }
            );
          } else {
            window.location = "/books/addBook";
          }
        });
        // const key = getCookie("token");
        // if (key) {
        //     window.location = "/addBook";
        //     return;
        // }
      }
    </script>
  </body>
</html>
